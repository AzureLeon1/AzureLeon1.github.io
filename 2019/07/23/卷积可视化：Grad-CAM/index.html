<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
  <title>卷积可视化：Grad-CAM | Leon Wang</title>
  <meta name="keywords" content=" 深度学习 ">
  <meta name="description" content="卷积可视化：Grad-CAM | Leon Wang">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="description" content="Leon Wang    I am an undergraduate majoring in Software Engineering in Tongji University.  Interest: &amp;nbsp;&amp;nbsp;&amp;nbsp;Machine Learning, Deep Learning, Computer Vision    GitHub: &amp;nbsp;&amp;nb">
<meta property="og:type" content="website">
<meta property="og:title" content="About Me">
<meta property="og:url" content="http://www.leonwang.top/about/index.html">
<meta property="og:site_name" content="Leon Wang">
<meta property="og:description" content="Leon Wang    I am an undergraduate majoring in Software Engineering in Tongji University.  Interest: &amp;nbsp;&amp;nbsp;&amp;nbsp;Machine Learning, Deep Learning, Computer Vision    GitHub: &amp;nbsp;&amp;nb">
<meta property="og:locale" content="en">
<meta property="og:image" content="http://img.cdn.leonwang.top/pic.jpeg">
<meta property="og:updated_time" content="2020-07-11T10:40:25.240Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="About Me">
<meta name="twitter:description" content="Leon Wang    I am an undergraduate majoring in Software Engineering in Tongji University.  Interest: &amp;nbsp;&amp;nbsp;&amp;nbsp;Machine Learning, Deep Learning, Computer Vision    GitHub: &amp;nbsp;&amp;nb">
<meta name="twitter:image" content="http://img.cdn.leonwang.top/pic.jpeg">


<link rel="icon" href="/img/avatar.jpg">

<link href="/css/style.css?v=1.1.0" rel="stylesheet">

<link href="/css/hl_theme/atom-light.css?v=1.1.0" rel="stylesheet">

<link href="//cdn.jsdelivr.net/npm/animate.css@4.1.0/animate.min.css" rel="stylesheet">

<script src="//cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
<script src="/js/titleTip.js?v=1.1.0"></script>

<script src="//cdn.jsdelivr.net/npm/highlightjs@9.16.2/highlight.pack.min.js"></script>
<script>
    hljs.initHighlightingOnLoad();
</script>

<script src="//cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js"></script>



<script src="//cdn.jsdelivr.net/npm/jquery.cookie@1.4.1/jquery.cookie.min.js"></script>

<script src="/js/iconfont.js?v=1.1.0"></script><!-- hexo-inject:begin --><!-- hexo-inject:end -->

</head>
<div style="display: none">
  <input class="theme_disqus_on" value="false">
  <input class="theme_preload_comment" value="">
  <input class="theme_blog_path" value="">
  <input id="theme_shortcut" value="true">
  <input id="theme_highlight_on" value="true">
  <input id="theme_code_copy" value="true">
</div>



<body>
<!-- hexo-inject:begin --><!-- hexo-inject:end --><aside class="nav">
    <div class="nav-left">
        <a href="/" class="avatar_target">
    <img class="avatar" src="/img/avatar.jpg">
</a>
<div class="author">
    <span>Leon Wang</span>
</div>

<div class="icon">
    
        
        <a title="rss" href="/atom.xml" target="_blank">
            
                <svg class="iconfont-svg" aria-hidden="true">
                    <use xlink:href="#icon-rss"/>
                </svg>
            
        </a>
        
    
        
        <a title="github" href="https://github.com/yelog" target="_blank">
            
                <svg class="iconfont-svg" aria-hidden="true">
                    <use xlink:href="#icon-github"/>
                </svg>
            
        </a>
        
    
        
        <a title="facebook" href="https://www.facebook.com/faker.tops" target="_blank">
            
                <svg class="iconfont-svg" aria-hidden="true">
                    <use xlink:href="#icon-facebook"/>
                </svg>
            
        </a>
        
    
        
    
        
    
        
        <a title="instagram" href="https://www.facebook.com/faker.tops" target="_blank">
            
                <svg class="iconfont-svg" aria-hidden="true">
                    <use xlink:href="#icon-instagram"/>
                </svg>
            
        </a>
        
    
        
        <a title="reddit" href="https://www.reddit.com/user/yelog/" target="_blank">
            
                <svg class="iconfont-svg" aria-hidden="true">
                    <use xlink:href="#icon-reddit"/>
                </svg>
            
        </a>
        
    
        
        <a title="weibo" href="http://weibo.com/u/2307534817" target="_blank">
            
                <svg class="iconfont-svg" aria-hidden="true">
                    <use xlink:href="#icon-weibo"/>
                </svg>
            
        </a>
        
    
        
        <a title="jianshu" href="https://www.jianshu.com/u/ff56736de7cf" target="_blank">
            
                <svg class="iconfont-svg" aria-hidden="true">
                    <use xlink:href="#icon-jianshu"/>
                </svg>
            
        </a>
        
    
        
        <a title="zhihu" href="https://www.zhihu.com/people/jaytp/activities" target="_blank">
            
                <svg class="iconfont-svg" aria-hidden="true">
                    <use xlink:href="#icon-zhihu"/>
                </svg>
            
        </a>
        
    
        
    
        
        <a title="oschina" href="https://my.oschina.net/yelog" target="_blank">
            
                <svg class="iconfont-svg" aria-hidden="true">
                    <use xlink:href="#icon-oschina"/>
                </svg>
            
        </a>
        
    
        
    
        
        <a title="email" href="mailto:jaytp@qq.com" target="_blank">
            
                <svg class="iconfont-svg" aria-hidden="true">
                    <use xlink:href="#icon-email"/>
                </svg>
            
        </a>
        
    
        
        <a title="qq" href="http://wpa.qq.com/msgrd?v=3&uin=872336115&site=qq&menu=yes" target="_blank">
            
                <svg class="iconfont-svg" aria-hidden="true">
                    <use xlink:href="#icon-qq"/>
                </svg>
            
        </a>
        
    
        
        <a title="kugou" href="https://www.kugou.com/" target="_blank">
            
                <svg class="iconfont-svg" aria-hidden="true">
                    <use xlink:href="#icon-kugou"/>
                </svg>
            
        </a>
        
    
        
        <a title="neteasemusic" href="https://music.163.com/#/user/home?id=88151013" target="_blank">
            
                <svg class="iconfont-svg" aria-hidden="true">
                    <use xlink:href="#icon-neteasemusic"/>
                </svg>
            
        </a>
        
    
</div>




<ul>
    <li><div class="all active" data-rel="All">All<small>(39)</small></div></li>
    
        
            
            <li><div data-rel="机器学习">机器学习<small>(12)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="计算机网络">计算机网络<small>(2)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="深度学习">深度学习<small>(3)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="数学">数学<small>(3)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="Algorithm">Algorithm<small>(1)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="Android">Android<small>(1)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="ARCore">ARCore<small>(3)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="Blog搭建">Blog搭建<small>(2)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="Git">Git<small>(1)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="LeetCode">LeetCode<small>(1)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="Solutions">Solutions<small>(1)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="UML">UML<small>(1)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="Web">Web<small>(3)</small></div>
                
            </li>
            
        
    
</ul>
<div class="left-bottom">
    <div class="menus">
    
    
    
    
    </div>
    <div><a class="about  hasFriend  site_url" href="/about">About</a><a style="width: 50%" class="friends">Friends</a></div>
</div>
<input type="hidden" id="yelog_site_posts_number" value="39">

<div style="display: none">
    <span id="busuanzi_value_site_uv"></span>
    <span id="busuanzi_value_site_pv"></span>
</div>

    </div>
    <div class="nav-right">
        <div class="friends-area">
    <div class="friends-title">
        Links
        <i class="iconfont icon-left"></i>
    </div>
    <div class="friends-content">
        <ul>
            
            <li><a target="_blank" href="http://yelog.org/">叶落阁</a></li>
            
        </ul>
    </div>
</div>
        <div class="title-list">
    <div class="right-top">
        <div id="default-panel">
            <i class="iconfont icon-search" data-title="搜索 快捷键 i"></i>
            <div class="right-title">All</div>
            <i class="iconfont icon-file-tree" data-title="切换到大纲视图 快捷键 w"></i>
        </div>
        <div id="search-panel">
            <i class="iconfont icon-left" data-title="返回"></i>
            <input id="local-search-input">
            <label class="border-line" for="input"></label>
            <i class="iconfont icon-case-sensitive" data-title="大小写敏感"></i>
            <i class="iconfont icon-tag" data-title="标签"></i>
        </div>
        <div id="outline-panel" style="display: none">
            <div class="right-title">大纲</div>
            <i class="iconfont icon-list" data-title="切换到文章列表"></i>
        </div>
    </div>

    <div class="tags-list">
    <input id="tag-search">
    <div class="tag-wrapper">
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>分割</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>分支</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>概率论与数理统计</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>感知机</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>过拟合</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>机器学习</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>计算机视觉</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>计算机网络</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>朴素贝叶斯</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>奇异值</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>奇异值分解</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>前端</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>欠拟合</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>深度学习</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>数学</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>损失函数</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>统计学习方法</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>吴恩达</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>线性代数</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>虚函数</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>异常检测</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Algorithm</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Android</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>AR</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>ARCore</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Blog</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>C++</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Cross Validation</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>css</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>GAN</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Git</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>GitHub</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Hexo</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>html</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Java</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>JavaScript</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>LeetCode</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>ns-3</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>React</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>solutions</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>U-Net</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Ubuntu</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>UML</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>ViewPager</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>ViewPagerTransforms</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Web</a>
            </li>
        
    </div>

</div>

    
    <nav id="title-list-nav">
        
        <a class="All LeetCode " href="/2020/07/11/LeetCode11-vs-LeetCode84/" data-tag="LeetCode" data-author="">
            <span class="post-title" title="LeetCode11 vs LeetCode84">LeetCode11 vs LeetCode84</span>
            <span class="post-date" title="2020-07-11 18:32:17">2020/07/11</span>
        </a>
        
        <a class="All 机器学习 " href="/2020/04/07/Loss-Function-for-Medical-and-Non-medical-Image-Segmentation/" data-tag="机器学习,深度学习,分割,计算机视觉,损失函数" data-author="">
            <span class="post-title" title="Loss Function for Medical and Non-medical Image Segmentation">Loss Function for Medical and Non-medical Image Segmentation</span>
            <span class="post-date" title="2020-04-07 19:08:53">2020/04/07</span>
        </a>
        
        <a class="All 机器学习 " href="/2020/03/22/U-Net/" data-tag="机器学习,分割,计算机视觉,U-Net" data-author="">
            <span class="post-title" title="U-Net">U-Net</span>
            <span class="post-date" title="2020-03-22 09:59:36">2020/03/22</span>
        </a>
        
        <a class="All 机器学习 " href="/2020/03/22/Segmentation-Review/" data-tag="机器学习,深度学习,分割,计算机视觉" data-author="">
            <span class="post-title" title="Segmentation Review">Segmentation Review</span>
            <span class="post-date" title="2020-03-22 09:52:25">2020/03/22</span>
        </a>
        
        <a class="All 机器学习 " href="/2020/03/15/Bias-Variance-N-fold-Cross-Validation/" data-tag="机器学习,过拟合,欠拟合,Cross Validation" data-author="">
            <span class="post-title" title="Bias, Variance, N-fold Cross Validation">Bias, Variance, N-fold Cross Validation</span>
            <span class="post-date" title="2020-03-15 10:00:37">2020/03/15</span>
        </a>
        
        <a class="All 数学 " href="/2020/03/01/概率论与数理统计/" data-tag="概率论与数理统计" data-author="">
            <span class="post-title" title="概率论与数理统计">概率论与数理统计</span>
            <span class="post-date" title="2020-03-01 00:11:03">2020/03/01</span>
        </a>
        
        <a class="All 数学 " href="/2020/02/29/奇异值分解-SVD-Singular-Value-Decomposition/" data-tag="数学,线性代数,奇异值,奇异值分解" data-author="">
            <span class="post-title" title="奇异值分解 (SVD, Singular Value Decomposition)">奇异值分解 (SVD, Singular Value Decomposition)</span>
            <span class="post-date" title="2020-02-29 01:26:56">2020/02/29</span>
        </a>
        
        <a class="All 数学 " href="/2020/02/29/Linear-Algebra/" data-tag="数学,线性代数" data-author="">
            <span class="post-title" title="Linear Algebra">Linear Algebra</span>
            <span class="post-date" title="2020-02-29 00:52:49">2020/02/29</span>
        </a>
        
        <a class="All 机器学习 " href="/2019/11/11/朴素贝叶斯分类算法/" data-tag="机器学习,朴素贝叶斯" data-author="">
            <span class="post-title" title="朴素贝叶斯分类算法">朴素贝叶斯分类算法</span>
            <span class="post-date" title="2019-11-11 18:17:47">2019/11/11</span>
        </a>
        
        <a class="All 深度学习 " href="/2019/11/07/GAN异常检测/" data-tag="深度学习,GAN,异常检测" data-author="">
            <span class="post-title" title="GAN异常检测">GAN异常检测</span>
            <span class="post-date" title="2019-11-07 21:34:36">2019/11/07</span>
        </a>
        
        <a class="All 机器学习 " href="/2019/11/07/机器学习分类/" data-tag="机器学习" data-author="">
            <span class="post-title" title="机器学习分类">机器学习分类</span>
            <span class="post-date" title="2019-11-07 21:29:27">2019/11/07</span>
        </a>
        
        <a class="All 机器学习 " href="/2019/11/03/关于感知机学习算法的对偶形式/" data-tag="机器学习,统计学习方法,感知机" data-author="">
            <span class="post-title" title="关于感知机学习算法的对偶形式">关于感知机学习算法的对偶形式</span>
            <span class="post-date" title="2019-11-03 16:54:10">2019/11/03</span>
        </a>
        
        <a class="All " href="/2019/10/09/C-vs-Java-之虚函数/" data-tag="C++,Java,虚函数" data-author="">
            <span class="post-title" title="C++ vs Java 之虚函数">C++ vs Java 之虚函数</span>
            <span class="post-date" title="2019-10-09 21:54:29">2019/10/09</span>
        </a>
        
        <a class="All 机器学习 " href="/2019/09/09/yolov3-Keras实现解读/" data-tag="机器学习" data-author="">
            <span class="post-title" title="yolov3 Keras实现解读">yolov3 Keras实现解读</span>
            <span class="post-date" title="2019-09-09 19:41:37">2019/09/09</span>
        </a>
        
        <a class="All 机器学习 " href="/2019/07/24/Stanford-ML-Note/" data-tag="机器学习,吴恩达" data-author="">
            <span class="post-title" title="Stanford ML Note">Stanford ML Note</span>
            <span class="post-date" title="2019-07-24 12:52:02">2019/07/24</span>
        </a>
        
        <a class="All 深度学习 " href="/2019/07/23/Global-Average-Pooling/" data-tag="深度学习" data-author="">
            <span class="post-title" title="Global Average Pooling">Global Average Pooling</span>
            <span class="post-date" title="2019-07-23 15:25:20">2019/07/23</span>
        </a>
        
        <a class="All 深度学习 " href="/2019/07/23/卷积可视化：Grad-CAM/" data-tag="深度学习" data-author="">
            <span class="post-title" title="卷积可视化：Grad-CAM">卷积可视化：Grad-CAM</span>
            <span class="post-date" title="2019-07-23 14:49:26">2019/07/23</span>
        </a>
        
        <a class="All 机器学习 " href="/2019/07/21/ResNet-K-Fold-Cross-Validation/" data-tag="机器学习" data-author="">
            <span class="post-title" title="ResNet &amp; K-Fold Cross Validation">ResNet &amp; K-Fold Cross Validation</span>
            <span class="post-date" title="2019-07-21 11:32:14">2019/07/21</span>
        </a>
        
        <a class="All 机器学习 " href="/2019/07/21/Siamese-Network/" data-tag="机器学习" data-author="">
            <span class="post-title" title="Siamese Network">Siamese Network</span>
            <span class="post-date" title="2019-07-21 11:31:50">2019/07/21</span>
        </a>
        
        <a class="All 机器学习 " href="/2019/07/21/Keras-中的损失函数/" data-tag="机器学习" data-author="">
            <span class="post-title" title="Keras 中的损失函数">Keras 中的损失函数</span>
            <span class="post-date" title="2019-07-21 11:31:32">2019/07/21</span>
        </a>
        
        <a class="All " href="/2019/07/16/Xrandr-displaying-“Failed-to-get-size-of-gamma-for-output-default”/" data-tag="Ubuntu" data-author="">
            <span class="post-title" title="Xrandr displaying “Failed to get size of gamma for output default”">Xrandr displaying “Failed to get size of gamma for output default”</span>
            <span class="post-date" title="2019-07-16 10:42:10">2019/07/16</span>
        </a>
        
        <a class="All " href="/2019/07/07/el-button样式/" data-tag="" data-author="">
            <span class="post-title" title="el-button样式">el-button样式</span>
            <span class="post-date" title="2019-07-07 21:26:39">2019/07/07</span>
        </a>
        
        <a class="All " href="/2019/06/05/ajax和axios、fetch的区别/" data-tag="Web" data-author="">
            <span class="post-title" title="ajax和axios、fetch的区别">ajax和axios、fetch的区别</span>
            <span class="post-date" title="2019-06-05 19:40:04">2019/06/05</span>
        </a>
        
        <a class="All " href="/2019/05/18/go-echo后端处理跨域的两种方式/" data-tag="" data-author="">
            <span class="post-title" title="go echo后端处理跨域的两种方式">go echo后端处理跨域的两种方式</span>
            <span class="post-date" title="2019-05-18 00:48:13">2019/05/18</span>
        </a>
        
        <a class="All Web " href="/2019/05/08/Fetch-API-检测请求是否成功/" data-tag="Web,JavaScript" data-author="">
            <span class="post-title" title="Fetch API 检测请求是否成功">Fetch API 检测请求是否成功</span>
            <span class="post-date" title="2019-05-08 00:12:09">2019/05/08</span>
        </a>
        
        <a class="All Algorithm " href="/2019/03/19/Analysis-and-Design-of-Algorithms/" data-tag="Algorithm" data-author="">
            <span class="post-title" title="Analysis and Design of Algorithms">Analysis and Design of Algorithms</span>
            <span class="post-date" title="2019-03-19 20:55:58">2019/03/19</span>
        </a>
        
        <a class="All UML " href="/2019/03/16/UML和模式应用-Note/" data-tag="UML" data-author="">
            <span class="post-title" title="UML和模式应用 Note">UML和模式应用 Note</span>
            <span class="post-date" title="2019-03-16 15:05:56">2019/03/16</span>
        </a>
        
        <a class="All Web " href="/2019/03/16/React-Note/" data-tag="Web,React,前端" data-author="">
            <span class="post-title" title="React Note">React Note</span>
            <span class="post-date" title="2019-03-16 15:05:38">2019/03/16</span>
        </a>
        
        <a class="All ARCore " href="/2019/02/14/ARCore踩坑——无法放置3D模型/" data-tag="ARCore,AR,Android" data-author="">
            <span class="post-title" title="ARCore踩坑——无法放置3D模型">ARCore踩坑——无法放置3D模型</span>
            <span class="post-date" title="2019-02-14 12:13:27">2019/02/14</span>
        </a>
        
        <a class="All Git " href="/2019/02/02/Git本地分支与远程分支/" data-tag="Git,GitHub,分支" data-author="">
            <span class="post-title" title="Git本地分支与远程分支">Git本地分支与远程分支</span>
            <span class="post-date" title="2019-02-02 11:17:49">2019/02/02</span>
        </a>
        
        <a class="All Android " href="/2019/01/27/ViewPager与ViewPagerTransforms/" data-tag="Android,ViewPager,ViewPagerTransforms" data-author="">
            <span class="post-title" title="ViewPager与ViewPagerTransforms">ViewPager与ViewPagerTransforms</span>
            <span class="post-date" title="2019-01-27 10:35:51">2019/01/27</span>
        </a>
        
        <a class="All Solutions " href="/2018/12/14/Awesome-Solutions/" data-tag="solutions" data-author="">
            <span class="post-title" title="Awesome Solutions">Awesome Solutions</span>
            <span class="post-date" title="2018-12-14 20:59:16">2018/12/14</span>
        </a>
        
        <a class="All Web " href="/2018/12/14/Web开发笔记/" data-tag="Web,前端,html,css" data-author="">
            <span class="post-title" title="Web开发笔记">Web开发笔记</span>
            <span class="post-date" title="2018-12-14 20:25:44">2018/12/14</span>
        </a>
        
        <a class="All 计算机网络 " href="/2018/12/07/ns-3使用总结/" data-tag="计算机网络,ns-3" data-author="">
            <span class="post-title" title="ns-3使用及计网实验总结">ns-3使用及计网实验总结</span>
            <span class="post-date" title="2018-12-07 23:52:51">2018/12/07</span>
        </a>
        
        <a class="All 计算机网络 " href="/2018/12/02/ns-3入门/" data-tag="计算机网络,ns-3" data-author="">
            <span class="post-title" title="ns-3入门">ns-3入门</span>
            <span class="post-date" title="2018-12-02 00:44:45">2018/12/02</span>
        </a>
        
        <a class="All ARCore " href="/2018/11/22/ARCore-3D模型/" data-tag="ARCore,AR,Android" data-author="">
            <span class="post-title" title="ARCore 3D模型">ARCore 3D模型</span>
            <span class="post-date" title="2018-11-22 23:10:23">2018/11/22</span>
        </a>
        
        <a class="All ARCore " href="/2018/11/22/ARCore-SDK-sample-代码分析/" data-tag="ARCore,AR,Android" data-author="">
            <span class="post-title" title="ARCore SDK sample 代码分析">ARCore SDK sample 代码分析</span>
            <span class="post-date" title="2018-11-22 23:01:45">2018/11/22</span>
        </a>
        
        <a class="All Blog搭建 " href="/2018/11/17/阿里云ECS-Hexo搭建个人博客/" data-tag="Blog,Hexo" data-author="">
            <span class="post-title" title="阿里云ECS+Hexo搭建个人博客">阿里云ECS+Hexo搭建个人博客</span>
            <span class="post-date" title="2018-11-17 00:24:26">2018/11/17</span>
        </a>
        
        <a class="All Blog搭建 " href="/2018/11/16/hello-hexo/" data-tag="Blog,Hexo" data-author="">
            <span class="post-title" title="Hello Hexo">Hello Hexo</span>
            <span class="post-date" title="2018-11-16 14:55:16">2018/11/16</span>
        </a>
        
        <div id="no-item-tips">

        </div>
    </nav>
    <div id="outline-list">
    </div>
</div>
    </div>
    <div class="hide-list">
        <div class="semicircle" data-title="切换全屏 快捷键 s">
            <div class="brackets first"><</div>
            <div class="brackets">&gt;</div>
        </div>
    </div>
</aside>
<div id="post">
    <div class="pjax">
        <article id="post-卷积可视化：Grad-CAM" class="article article-type-post" itemscope="" itemprop="blogPost">
    
        <h1 class="article-title">卷积可视化：Grad-CAM</h1>
    
    <div class="article-meta">
        
        
        
        <span class="book">
            <i class="iconfont icon-category"></i>
            
            
            <a data-rel="深度学习">深度学习</a>
            
        </span>
        
        
        <span class="tag">
            <i class="iconfont icon-tag"></i>
            
            <a class="color5">深度学习</a>
            
        </span>
        
    </div>
    <div class="article-meta">
        
            Created At : <time class="date" title="Updated At: 2019-07-25 16:44:28">2019-07-23 14:49</time>
        
    </div>
    <div class="article-meta">
        
        
        <span id="busuanzi_container_page_pv">
            Views 👀 :<span id="busuanzi_value_page_pv">
                <span class="count-comment">
                    <span class="spinner">
                      <div class="cube1"></div>
                      <div class="cube2"></div>
                    </span>
                </span>
            </span>
        </span>
        
        
    </div>
    
    <div class="toc-ref">
    
        <ol class="toc"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-CAM"><span class="toc-text">1. CAM</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-Grad-CAM"><span class="toc-text">2. Grad-CAM</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-效果展示"><span class="toc-text">3. 效果展示</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-keras-实现-Grad-CAM"><span class="toc-text">4. keras 实现 Grad-CAM</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-pytorch-实现-Grad-CAM展开目录"><span class="toc-text">5. pytorch 实现 Grad-CAM展开目录</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#6-参考文献"><span class="toc-text">6. 参考文献</span></a></li></ol>
    
<style>
    .left-col .switch-btn,
    .left-col .switch-area {
        display: none;
    }
    .toc-level-3 i,
    .toc-level-3 ol {
        display: none !important;
    }
</style>
</div>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>论文<a href="http://cn.arxiv.org/pdf/1610.02391v3" target="_blank" rel="noopener">《Grad-CAM:Visual Explanations from Deep Networks via Gradient-based Localization》</a>，文中介绍了一种<code>卷积神经网络的解释方法</code>，通过构建类似热力图 (heatmap) 的形式，直观展示出卷积神经网络学习到的特征，简单说就是：到底我的模型关注点在哪？凭啥认为这张图中有猫？当然，其本质还是从像素角度去解释，并不能像人类那样直观的解释某一个动物为什么是猫。</p>
<h5 id="1-CAM"><a href="#1-CAM" class="headerlink" title="1. CAM"></a>1. CAM</h5><p>在很长一段时间内，CNN 虽然效果显著但却饱受争议，根源在于其可解释性较差，同时也因此衍生出一个新的领域：深度学习的可解释性研究。比较经典的研究方法是采用反卷积（Deconvolution）和导向反向传播（Guided-backpropagation），相关的论文也比较多就不在一一列举了，这里给出一个相对比较好的：<a href="http://cn.arxiv.org/pdf/1412.6806.pdf" target="_blank" rel="noopener">《Striving for Simplicity: The All Convolutional Net》</a>。</p>
<p>在介绍 CAM 之前最好对 <a href="http://spytensor.com/index.php/archives/19/" target="_blank" rel="noopener">GAP</a> 有一定的了解，因为 CAM 的作者就是借鉴了这个方法来处理。下图是 CAM 的一些直观描述：</p>
<p><img src="http://img.cdn.leonwang.top/20190723144640.png" alt=""></p>
<p>特征图经过 GAP 处理后每一个特征图包含了不同类别的信息，其具体效果如上图的 Class Activation Mapping 中的图片所示（只看图片，忽略公式），其中的权重 w 对应分类时的权重。这样做的缺陷是因为要替换全连接层为 GAP 层，因此模型要重新训练，这样的处理方式对于一些复杂的模型是行不通的，Grad-CAM 很好的解决了这个问题，具体继续往下看。</p>
<p>现在的问题是，即使模型训练好了，我们怎么绘制出热点图？这个比较简单，我们只需要提取出所有的权重，往回找到对应的特征图，然后进行加权求和即可。另外如果有兴趣进一步了解 CAM 的话，可以参考一下 Jacob Gildenblat 的复现： <a href="https://github.com/jacobgil/keras-cam" target="_blank" rel="noopener">keras-cam</a>, 提醒一下，这个代码本人没有进行测试，所以不能保证顺利运行。</p>
<p><strong>总结起来，CAM 的意义就是以热力图的形式告诉我们，模型通过哪些像素点得知图片属于某个类别。</strong></p>
<h5 id="2-Grad-CAM"><a href="#2-Grad-CAM" class="headerlink" title="2. Grad-CAM"></a>2. Grad-CAM</h5><p>其实 CAM 得到的效果已经很不错了，但是由于其需要修改网络结构并对模型进行重新训练，这样就导致其应用起来很不方便。Grad-CAM 和 CAM 基本思路一样，区别就在于如何获取每个特征图的权重，采用了梯度的全局平均来计算权重，论文中也给出了证明两种方式得到的权重是否等价的详细过程，如果有需要可以阅读论文进行推导。这里为了与 CAM 的权重进行区分，定义 Grad-CAM 中第 k 个特征图对应类别 c 的权重为 αkc，可以通过下面的公式计算得到：</p>
<p>$$<br>\alpha_{k}^{c}=\frac{1}{Z} \sum_{i} \sum_{j} \frac{\partial y^{c}}{\partial A_{i j}^{k}}<br>$$</p>
<p>参数解析：</p>
<ul>
<li>Z: 特征图的像素个数;</li>
<li>yc: 第 c 类得分的梯度 (the gradient of the score for class c)；</li>
<li>Aijk: 第 k 个特征图中，(i,j) 位置处的像素值；</li>
</ul>
<p>然后再求得所有的特征图对应的类别的权重后进行加权求和，这样便可以得到最后的热力图，求和公式如下：</p>
<p>$$<br>L_{G r a d-C A M}^{c}=\operatorname{Re} L U\left(\sum_{k} \alpha_{k}^{c} A^{k}\right)<br>$$</p>
<p>下图是论文中给出的 Grad-CAM 整体结构图：</p>
<p><img src="http://img.cdn.leonwang.top/20190723144659.png" alt=""></p>
<p><strong>提醒：</strong><br>论文中对最终的加权结果进行了一次 ReLU 激活处理，目的是只考虑对类别 c 有正影响的像素点。</p>
<h5 id="3-效果展示"><a href="#3-效果展示" class="headerlink" title="3. 效果展示"></a>3. 效果展示</h5><p><img src="http://img.cdn.leonwang.top/20190723144712.png" alt=""></p>
<h5 id="4-keras-实现-Grad-CAM"><a href="#4-keras-实现-Grad-CAM" class="headerlink" title="4. keras 实现 Grad-CAM"></a>4. keras 实现 Grad-CAM</h5><p>源码为 <a href="https://github.com/jacobgil/keras-grad-cam" target="_blank" rel="noopener">Github:keras-grad-cam</a>，但是可能因为框架版本的原因，存在较多的 bug 我修改后可以正常运行，贴出我纠正好的代码，另外这里只给出了 VGG16 的实现，其他模型请自行阅读模型复现源码，进行修改即可，比较容易。<br><code>python 3.6</code> <code>python-opencv 3.4.2.17</code> <code>keras 2.2.0</code> <code>tensorflow 1.9.0</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> keras.applications.vgg16 <span class="keyword">import</span> (</span><br><span class="line">    VGG16, preprocess_input, decode_predictions)</span><br><span class="line"><span class="keyword">from</span> keras.preprocessing <span class="keyword">import</span> image</span><br><span class="line"><span class="keyword">from</span> keras.layers.core <span class="keyword">import</span> Lambda</span><br><span class="line"><span class="keyword">from</span> keras.models <span class="keyword">import</span> Model</span><br><span class="line"><span class="keyword">from</span> tensorflow.python.framework <span class="keyword">import</span> ops</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> keras.backend <span class="keyword">as</span> K</span><br><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> keras</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">target_category_loss</span><span class="params">(x, category_index, nb_classes)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> tf.multiply(x, K.one_hot([category_index], nb_classes))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">target_category_loss_output_shape</span><span class="params">(input_shape)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> input_shape</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">normalize</span><span class="params">(x)</span>:</span></span><br><span class="line">    <span class="comment"># utility function to normalize a tensor by its L2 norm</span></span><br><span class="line">    <span class="keyword">return</span> x / (K.sqrt(K.mean(K.square(x))) + <span class="number">1e-5</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">load_image</span><span class="params">(path)</span>:</span></span><br><span class="line">    img_path = path</span><br><span class="line">    img = image.load_img(img_path, target_size=(<span class="number">224</span>, <span class="number">224</span>))</span><br><span class="line">    x = image.img_to_array(img)</span><br><span class="line">    x = np.expand_dims(x, axis=<span class="number">0</span>)</span><br><span class="line">    x = preprocess_input(x)</span><br><span class="line">    <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register_gradient</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">"GuidedBackProp"</span> <span class="keyword">not</span> <span class="keyword">in</span> ops._gradient_registry._registry:</span><br><span class="line"><span class="meta">        @ops.RegisterGradient("GuidedBackProp")</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">_GuidedBackProp</span><span class="params">(op, grad)</span>:</span></span><br><span class="line">            dtype = op.inputs[<span class="number">0</span>].dtype</span><br><span class="line">            <span class="keyword">return</span> grad * tf.cast(grad &gt; <span class="number">0.</span>, dtype) * \</span><br><span class="line">                tf.cast(op.inputs[<span class="number">0</span>] &gt; <span class="number">0.</span>, dtype)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">compile_saliency_function</span><span class="params">(model, activation_layer=<span class="string">'block5_conv3'</span>)</span>:</span></span><br><span class="line">    input_img = model.input</span><br><span class="line">    layer_dict = dict([(layer.name, layer) <span class="keyword">for</span> layer <span class="keyword">in</span> model.layers[<span class="number">1</span>:]])</span><br><span class="line">    layer_output = layer_dict[activation_layer].output</span><br><span class="line">    max_output = K.max(layer_output, axis=<span class="number">3</span>)</span><br><span class="line">    saliency = K.gradients(K.sum(max_output), input_img)[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">return</span> K.function([input_img, K.learning_phase()], [saliency])</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">modify_backprop</span><span class="params">(model, name)</span>:</span></span><br><span class="line">    g = tf.get_default_graph()</span><br><span class="line">    <span class="keyword">with</span> g.gradient_override_map(&#123;<span class="string">'Relu'</span>: name&#125;):</span><br><span class="line"></span><br><span class="line">        <span class="comment"># get layers that have an activation</span></span><br><span class="line">        layer_dict = [layer <span class="keyword">for</span> layer <span class="keyword">in</span> model.layers[<span class="number">1</span>:]</span><br><span class="line">                      <span class="keyword">if</span> hasattr(layer, <span class="string">'activation'</span>)]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># replace relu activation</span></span><br><span class="line">        <span class="keyword">for</span> layer <span class="keyword">in</span> layer_dict:</span><br><span class="line">            <span class="keyword">if</span> layer.activation == keras.activations.relu:</span><br><span class="line">                layer.activation = tf.nn.relu</span><br><span class="line"></span><br><span class="line">        <span class="comment"># re-instanciate a new model</span></span><br><span class="line">        new_model = VGG16(weights=<span class="string">'imagenet'</span>)</span><br><span class="line">    <span class="keyword">return</span> new_model</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">deprocess_image</span><span class="params">(x)</span>:</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    Same normalization as in:</span></span><br><span class="line"><span class="string">    https://github.com/fchollet/keras/blob/master/examples/conv_filter_visualization.py</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    <span class="keyword">if</span> np.ndim(x) &gt; <span class="number">3</span>:</span><br><span class="line">        x = np.squeeze(x)</span><br><span class="line">    <span class="comment"># normalize tensor: center on 0., ensure std is 0.1</span></span><br><span class="line">    x -= x.mean()</span><br><span class="line">    x /= (x.std() + <span class="number">1e-5</span>)</span><br><span class="line">    x *= <span class="number">0.1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># clip to [0, 1]</span></span><br><span class="line">    x += <span class="number">0.5</span></span><br><span class="line">    x = np.clip(x, <span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># convert to RGB array</span></span><br><span class="line">    x *= <span class="number">255</span></span><br><span class="line">    <span class="keyword">if</span> K.image_dim_ordering() == <span class="string">'th'</span>:</span><br><span class="line">        x = x.transpose((<span class="number">1</span>, <span class="number">2</span>, <span class="number">0</span>))</span><br><span class="line">    x = np.clip(x, <span class="number">0</span>, <span class="number">255</span>).astype(<span class="string">'uint8'</span>)</span><br><span class="line">    <span class="keyword">return</span> x</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_compute_gradients</span><span class="params">(tensor, var_list)</span>:</span></span><br><span class="line">  grads = tf.gradients(tensor, var_list)</span><br><span class="line">  <span class="keyword">return</span> [grad <span class="keyword">if</span> grad <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span> <span class="keyword">else</span> tf.zeros_like(var)</span><br><span class="line">          <span class="keyword">for</span> var, grad <span class="keyword">in</span> zip(var_list, grads)]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">grad_cam</span><span class="params">(input_model, image, category_index, layer_name)</span>:</span></span><br><span class="line">    nb_classes = <span class="number">1000</span></span><br><span class="line">    target_layer = <span class="keyword">lambda</span> x: target_category_loss(x, category_index, nb_classes)</span><br><span class="line">    x = Lambda(target_layer, output_shape = target_category_loss_output_shape)(input_model.output)</span><br><span class="line">    model = Model(inputs=input_model.input, outputs=x)</span><br><span class="line">    model.summary()</span><br><span class="line">    loss = K.sum(model.output)</span><br><span class="line">    conv_output =  [l <span class="keyword">for</span> l <span class="keyword">in</span> model.layers <span class="keyword">if</span> l.name <span class="keyword">is</span> layer_name][<span class="number">0</span>].output</span><br><span class="line">    grads = normalize(_compute_gradients(loss, [conv_output])[<span class="number">0</span>])</span><br><span class="line">    gradient_function = K.function([model.input], [conv_output, grads])</span><br><span class="line"></span><br><span class="line">    output, grads_val = gradient_function([image])</span><br><span class="line">    output, grads_val = output[<span class="number">0</span>, :], grads_val[<span class="number">0</span>, :, :, :]</span><br><span class="line"></span><br><span class="line">    weights = np.mean(grads_val, axis = (<span class="number">0</span>, <span class="number">1</span>))</span><br><span class="line">    cam = np.ones(output.shape[<span class="number">0</span> : <span class="number">2</span>], dtype = np.float32)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i, w <span class="keyword">in</span> enumerate(weights):</span><br><span class="line">        cam += w * output[:, :, i]</span><br><span class="line"></span><br><span class="line">    cam = cv2.resize(cam, (<span class="number">224</span>, <span class="number">224</span>))</span><br><span class="line">    cam = np.maximum(cam, <span class="number">0</span>)</span><br><span class="line">    heatmap = cam / np.max(cam)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#Return to BGR [0..255] from the preprocessed image</span></span><br><span class="line">    image = image[<span class="number">0</span>, :]</span><br><span class="line">    image -= np.min(image)</span><br><span class="line">    image = np.minimum(image, <span class="number">255</span>)</span><br><span class="line"></span><br><span class="line">    cam = cv2.applyColorMap(np.uint8(<span class="number">255</span>*heatmap), cv2.COLORMAP_JET)</span><br><span class="line">    cam = np.float32(cam) + np.float32(image)</span><br><span class="line">    cam = <span class="number">255</span> * cam / np.max(cam)</span><br><span class="line">    <span class="keyword">return</span> np.uint8(cam), heatmap</span><br><span class="line"></span><br><span class="line">preprocessed_input = load_image(<span class="string">"../../images/dog-cat.jpg"</span>)</span><br><span class="line"></span><br><span class="line">model = VGG16(weights=<span class="string">'imagenet'</span>)</span><br><span class="line"></span><br><span class="line">predictions = model.predict(preprocessed_input)</span><br><span class="line">top_1 = decode_predictions(predictions)[<span class="number">0</span>][<span class="number">0</span>]</span><br><span class="line">print(<span class="string">'Predicted class:'</span>)</span><br><span class="line">print(<span class="string">'%s (%s) with probability %.2f'</span> % (top_1[<span class="number">1</span>], top_1[<span class="number">0</span>], top_1[<span class="number">2</span>]))</span><br><span class="line"></span><br><span class="line">predicted_class = np.argmax(predictions)</span><br><span class="line">cam, heatmap = grad_cam(model, preprocessed_input, predicted_class, <span class="string">"block5_conv3"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># cv2.imwrite("../../images/gradcam.jpg", cam)</span></span><br><span class="line"></span><br><span class="line">register_gradient()</span><br><span class="line">guided_model = modify_backprop(model, <span class="string">'GuidedBackProp'</span>)</span><br><span class="line">saliency_fn = compile_saliency_function(guided_model)</span><br><span class="line">saliency = saliency_fn([preprocessed_input, <span class="number">0</span>])</span><br><span class="line">gradcam = saliency[<span class="number">0</span>] * heatmap[..., np.newaxis]</span><br><span class="line"><span class="comment"># cv2.imwrite("../../images/guided_gradcam.jpg", deprocess_image(gradcam))</span></span><br><span class="line"></span><br><span class="line">origin_img = cv2.imread(<span class="string">"../../images/dog-cat.jpg"</span>)</span><br><span class="line">origin_img = cv2.resize(origin_img,(<span class="number">414</span>,<span class="number">414</span>))</span><br><span class="line">cam = cv2.resize(cam,(<span class="number">414</span>,<span class="number">414</span>))</span><br><span class="line">guided_gradcam = cv2.resize(deprocess_image(gradcam),(<span class="number">414</span>,<span class="number">414</span>))</span><br><span class="line"></span><br><span class="line">plt.subplot(<span class="number">2</span>,<span class="number">2</span>,<span class="number">1</span>), plt.imshow(origin_img), plt.title(<span class="string">'origin'</span>), plt.xticks([]), plt.yticks([])</span><br><span class="line">plt.subplot(<span class="number">2</span>,<span class="number">2</span>,<span class="number">3</span>), plt.imshow(cam), plt.title(<span class="string">'gradcam'</span>), plt.xticks([]), plt.yticks([])</span><br><span class="line">plt.subplot(<span class="number">2</span>,<span class="number">2</span>,<span class="number">4</span>), plt.imshow(guided_gradcam), plt.title(<span class="string">'guided_gradcam'</span>), plt.xticks([]), plt.yticks([])</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<h5 id="5-pytorch-实现-Grad-CAM展开目录"><a href="#5-pytorch-实现-Grad-CAM展开目录" class="headerlink" title="5. pytorch 实现 Grad-CAM展开目录"></a>5. pytorch 实现 Grad-CAM展开目录</h5><p>另外再附上一份 pytorch 版本的实现，原地址为：<a href="https://github.com/jacobgil/pytorch-grad-cam" target="_blank" rel="noopener">pytorch-grad-cam</a>，由于版本的原因，需要做一些调整，我这边使用的是 <code>pytorch 0.4.0</code>，pytorch 不像 keras 那样接口一致，所以不同的网络模型实现方式有所不同，这里只给出了 VGG 的实现方式，若想要进行修改，详细阅读模型复现源码进行修改，或者移步 <a href="https://github.com/utkuozbulak/pytorch-cnn-visualizations" target="_blank" rel="noopener">pytorch-cnn-visualizations</a> ，这里给出了比较多的可视化方法。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">from</span> torch.autograd <span class="keyword">import</span> Variable</span><br><span class="line"><span class="keyword">from</span> torch.autograd <span class="keyword">import</span> Function</span><br><span class="line"><span class="keyword">from</span> torchvision <span class="keyword">import</span> models</span><br><span class="line"><span class="keyword">from</span> torchvision <span class="keyword">import</span> utils</span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FeatureExtractor</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="string">""" Class for extracting activations and </span></span><br><span class="line"><span class="string">    registering gradients from targetted intermediate layers """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, model, target_layers)</span>:</span></span><br><span class="line">        self.model = model</span><br><span class="line">        self.target_layers = target_layers</span><br><span class="line">        self.gradients = []</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">save_gradient</span><span class="params">(self, grad)</span>:</span></span><br><span class="line">        self.gradients.append(grad)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        outputs = []</span><br><span class="line">        self.gradients = []</span><br><span class="line">        <span class="keyword">for</span> name, module <span class="keyword">in</span> self.model._modules.items():</span><br><span class="line">            x = module(x)</span><br><span class="line">            <span class="keyword">if</span> name <span class="keyword">in</span> self.target_layers:</span><br><span class="line">                x.register_hook(self.save_gradient)</span><br><span class="line">                outputs += [x]</span><br><span class="line">        <span class="keyword">return</span> outputs, x</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ModelOutputs</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="string">""" Class for making a forward pass, and getting:</span></span><br><span class="line"><span class="string">    1. The network output.</span></span><br><span class="line"><span class="string">    2. Activations from intermeddiate targetted layers.</span></span><br><span class="line"><span class="string">    3. Gradients from intermeddiate targetted layers. """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, model, target_layers)</span>:</span></span><br><span class="line">        self.model = model</span><br><span class="line">        self.feature_extractor = FeatureExtractor(self.model.features, target_layers)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_gradients</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.feature_extractor.gradients</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        target_activations, output  = self.feature_extractor(x)</span><br><span class="line">        output = output.view(output.size(<span class="number">0</span>), <span class="number">-1</span>)</span><br><span class="line">        output = self.model.classifier(output)</span><br><span class="line">        <span class="keyword">return</span> target_activations, output</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">preprocess_image</span><span class="params">(img)</span>:</span></span><br><span class="line">    means=[<span class="number">0.485</span>, <span class="number">0.456</span>, <span class="number">0.406</span>]</span><br><span class="line">    stds=[<span class="number">0.229</span>, <span class="number">0.224</span>, <span class="number">0.225</span>]</span><br><span class="line"></span><br><span class="line">    preprocessed_img = img.copy()[: , :, ::<span class="number">-1</span>]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">3</span>):</span><br><span class="line">        preprocessed_img[:, :, i] = preprocessed_img[:, :, i] - means[i]</span><br><span class="line">        preprocessed_img[:, :, i] = preprocessed_img[:, :, i] / stds[i]</span><br><span class="line">    preprocessed_img = \</span><br><span class="line">        np.ascontiguousarray(np.transpose(preprocessed_img, (<span class="number">2</span>, <span class="number">0</span>, <span class="number">1</span>)))</span><br><span class="line">    preprocessed_img = torch.from_numpy(preprocessed_img)</span><br><span class="line">    preprocessed_img.unsqueeze_(<span class="number">0</span>)</span><br><span class="line">    input = Variable(preprocessed_img, requires_grad = <span class="keyword">True</span>)</span><br><span class="line">    <span class="keyword">return</span> input</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show_cam_on_image</span><span class="params">(img, mask)</span>:</span></span><br><span class="line">    heatmap = cv2.applyColorMap(np.uint8(<span class="number">255</span>*mask), cv2.COLORMAP_JET)</span><br><span class="line">    heatmap = np.float32(heatmap) / <span class="number">255</span></span><br><span class="line">    cam = heatmap + np.float32(img)</span><br><span class="line">    cam = cam / np.max(cam)</span><br><span class="line">    cv2.imwrite(<span class="string">"../../images/cam01.jpg"</span>, np.uint8(<span class="number">255</span> * cam))</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GradCam</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, model, target_layer_names, use_cuda)</span>:</span></span><br><span class="line">        self.model = model</span><br><span class="line">        self.model.eval()</span><br><span class="line">        self.cuda = use_cuda</span><br><span class="line">        <span class="keyword">if</span> self.cuda:</span><br><span class="line">            self.model = model.cuda()</span><br><span class="line"></span><br><span class="line">        self.extractor = ModelOutputs(self.model, target_layer_names)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span><span class="params">(self, input)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.model(input) </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, input, index = None)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> self.cuda:</span><br><span class="line">            features, output = self.extractor(input.cuda())</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            features, output = self.extractor(input)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> index == <span class="keyword">None</span>:</span><br><span class="line">            index = np.argmax(output.cpu().data.numpy())</span><br><span class="line"></span><br><span class="line">        one_hot = np.zeros((<span class="number">1</span>, output.size()[<span class="number">-1</span>]), dtype = np.float32)</span><br><span class="line">        one_hot[<span class="number">0</span>][index] = <span class="number">1</span></span><br><span class="line">        one_hot = Variable(torch.from_numpy(one_hot), requires_grad = <span class="keyword">True</span>)</span><br><span class="line">        <span class="keyword">if</span> self.cuda:</span><br><span class="line">            one_hot = torch.sum(one_hot.cuda() * output)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            one_hot = torch.sum(one_hot * output)</span><br><span class="line"></span><br><span class="line">        self.model.features.zero_grad()</span><br><span class="line">        self.model.classifier.zero_grad()</span><br><span class="line">        <span class="comment">#one_hot.backward(retain_variables=True)</span></span><br><span class="line">        one_hot.backward()</span><br><span class="line">        grads_val = self.extractor.get_gradients()[<span class="number">-1</span>].cpu().data.numpy()</span><br><span class="line"></span><br><span class="line">        target = features[<span class="number">-1</span>]</span><br><span class="line">        target = target.cpu().data.numpy()[<span class="number">0</span>, :]</span><br><span class="line"></span><br><span class="line">        weights = np.mean(grads_val, axis = (<span class="number">2</span>, <span class="number">3</span>))[<span class="number">0</span>, :]</span><br><span class="line">        cam = np.zeros(target.shape[<span class="number">1</span> : ], dtype = np.float32)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i, w <span class="keyword">in</span> enumerate(weights):</span><br><span class="line">            cam += w * target[i, :, :]</span><br><span class="line"></span><br><span class="line">        cam = np.maximum(cam, <span class="number">0</span>)</span><br><span class="line">        cam = cv2.resize(cam, (<span class="number">224</span>, <span class="number">224</span>))</span><br><span class="line">        cam = cam - np.min(cam)</span><br><span class="line">        cam = cam / np.max(cam)</span><br><span class="line">        <span class="keyword">return</span> cam</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GuidedBackpropReLU</span><span class="params">(Function)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span><span class="params">(self, input)</span>:</span></span><br><span class="line">        positive_mask = (input &gt; <span class="number">0</span>).type_as(input)</span><br><span class="line">        output = torch.addcmul(torch.zeros(input.size()).type_as(input), input, positive_mask)</span><br><span class="line">        self.save_for_backward(input, output)</span><br><span class="line">        <span class="keyword">return</span> output</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">backward</span><span class="params">(self, grad_output)</span>:</span></span><br><span class="line">        input, output = self.saved_tensors</span><br><span class="line">        grad_input = <span class="keyword">None</span></span><br><span class="line"></span><br><span class="line">        positive_mask_1 = (input &gt; <span class="number">0</span>).type_as(grad_output)</span><br><span class="line">        positive_mask_2 = (grad_output &gt; <span class="number">0</span>).type_as(grad_output)</span><br><span class="line">        grad_input = torch.addcmul(torch.zeros(input.size()).type_as(input), torch.addcmul(torch.zeros(input.size()).type_as(input), grad_output, positive_mask_1), positive_mask_2)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> grad_input</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GuidedBackpropReLUModel</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, model, use_cuda)</span>:</span></span><br><span class="line">        self.model = model</span><br><span class="line">        self.model.eval()</span><br><span class="line">        self.cuda = use_cuda</span><br><span class="line">        <span class="keyword">if</span> self.cuda:</span><br><span class="line">            self.model = model.cuda()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># replace ReLU with GuidedBackpropReLU</span></span><br><span class="line">        <span class="keyword">for</span> idx, module <span class="keyword">in</span> self.model.features._modules.items():</span><br><span class="line">            <span class="keyword">if</span> module.__class__.__name__ == <span class="string">'ReLU'</span>:</span><br><span class="line">                self.model.features._modules[idx] = GuidedBackpropReLU()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span><span class="params">(self, input)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.model(input)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, input, index = None)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> self.cuda:</span><br><span class="line">            output = self.forward(input.cuda())</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            output = self.forward(input)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> index == <span class="keyword">None</span>:</span><br><span class="line">            index = np.argmax(output.cpu().data.numpy())</span><br><span class="line"></span><br><span class="line">        one_hot = np.zeros((<span class="number">1</span>, output.size()[<span class="number">-1</span>]), dtype = np.float32)</span><br><span class="line">        one_hot[<span class="number">0</span>][index] = <span class="number">1</span></span><br><span class="line">        one_hot = Variable(torch.from_numpy(one_hot), requires_grad = <span class="keyword">True</span>)</span><br><span class="line">        <span class="keyword">if</span> self.cuda:</span><br><span class="line">            one_hot = torch.sum(one_hot.cuda() * output)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            one_hot = torch.sum(one_hot * output)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># self.model.features.zero_grad()</span></span><br><span class="line">        <span class="comment"># self.model.classifier.zero_grad()</span></span><br><span class="line">        one_hot.backward()</span><br><span class="line"></span><br><span class="line">        output = input.grad.cpu().data.numpy()</span><br><span class="line">        output = output[<span class="number">0</span>,:,:,:]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> output</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="string">""" python grad_cam.py &lt;path_to_image&gt;</span></span><br><span class="line"><span class="string">    1. Loads an image with opencv.</span></span><br><span class="line"><span class="string">    2. Preprocesses it for VGG19 and converts to a pytorch variable.</span></span><br><span class="line"><span class="string">    3. Makes a forward pass to find the category index with the highest score,</span></span><br><span class="line"><span class="string">    and computes intermediate activations.</span></span><br><span class="line"><span class="string">    Makes the visualization. """</span></span><br><span class="line"></span><br><span class="line">    image_path = <span class="string">"../../images/dog-cat.jpg"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Can work with any model, but it assumes that the model has a </span></span><br><span class="line">    <span class="comment"># feature method, and a classifier method,</span></span><br><span class="line">    <span class="comment"># as in the VGG models in torchvision.</span></span><br><span class="line">    grad_cam = GradCam(model = models.vgg19(pretrained=<span class="keyword">True</span>), \</span><br><span class="line">                    target_layer_names = [<span class="string">"35"</span>], use_cuda=<span class="keyword">True</span>)</span><br><span class="line"></span><br><span class="line">    img = cv2.imread(image_path, <span class="number">1</span>)</span><br><span class="line">    img = np.float32(cv2.resize(img, (<span class="number">224</span>, <span class="number">224</span>))) / <span class="number">255</span></span><br><span class="line">    input = preprocess_image(img)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># If None, returns the map for the highest scoring category.</span></span><br><span class="line">    <span class="comment"># Otherwise, targets the requested index.</span></span><br><span class="line">    target_index = <span class="keyword">None</span></span><br><span class="line"></span><br><span class="line">    mask = grad_cam(input, target_index)</span><br><span class="line"></span><br><span class="line">    show_cam_on_image(img, mask)</span><br><span class="line"></span><br><span class="line">    gb_model = GuidedBackpropReLUModel(model = models.vgg19(pretrained=<span class="keyword">True</span>), use_cuda=<span class="keyword">True</span>)</span><br><span class="line">    gb = gb_model(input, index=target_index)</span><br><span class="line">    utils.save_image(torch.from_numpy(gb), <span class="string">'../../images/gb.jpg'</span>)</span><br><span class="line"></span><br><span class="line">    cam_mask = np.zeros(gb.shape)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, gb.shape[<span class="number">0</span>]):</span><br><span class="line">        cam_mask[i, :, :] = mask</span><br><span class="line"></span><br><span class="line">    cam_gb = np.multiply(cam_mask, gb)</span><br><span class="line">    utils.save_image(torch.from_numpy(cam_gb), <span class="string">'../../images/cam_gb.jpg'</span>)</span><br></pre></td></tr></table></figure>
<h5 id="6-参考文献"><a href="#6-参考文献" class="headerlink" title="6. 参考文献"></a>6. 参考文献</h5><ul>
<li><a href="http://cn.arxiv.org/pdf/1610.02391v3" target="_blank" rel="noopener">《Grad-CAM:Visual Explanations from Deep Networks via Gradient-based Localization》</a></li>
<li><a href="http://cn.arxiv.org/pdf/1412.6806.pdf" target="_blank" rel="noopener">《Striving for Simplicity: The All Convolutional Net》</a></li>
<li><a href="https://github.com/jacobgil/keras-cam" target="_blank" rel="noopener">keras-cam</a></li>
<li><a href="https://github.com/jacobgil/keras-grad-cam" target="_blank" rel="noopener">Github:keras-grad-cam</a></li>
<li><a href="https://github.com/jacobgil/pytorch-grad-cam" target="_blank" rel="noopener">pytorch-grad-cam</a></li>
<li><a href="https://github.com/utkuozbulak/pytorch-cnn-visualizations" target="_blank" rel="noopener">pytorch-cnn-visualizations</a></li>
</ul>

      
       <hr><span style="font-style: italic;color: gray;"> 转载请注明来源，欢迎对文章中的引用来源进行考证，欢迎指出任何有错误或不够清晰的表达。可以在下面评论区评论，也可以邮件至 jaytp@qq.com </span>
    </div>
</article>


<p>
    <a class="dashang" onclick="dashangToggle()">💰</a>
</p>






    
        <!-- MathJax配置，可通过单美元符号书写行内公式等 -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
    "HTML-CSS": {
        preferredFont: "TeX",
        availableFonts: ["STIX","TeX"],
        linebreaks: { automatic:true },
        EqnChunk: (MathJax.Hub.Browser.isMobile ? 10 : 50)
    },
    tex2jax: {
        inlineMath: [ ["$", "$"], ["\\(","\\)"] ],
        processEscapes: true,
        ignoreClass: "tex2jax_ignore|dno",
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    TeX: {
        equationNumbers: { autoNumber: "AMS" },
        noUndefined: { attributes: { mathcolor: "red", mathbackground: "#FFEEEE", mathsize: "90%" } },
        Macros: { href: "{}" }
    },
    messageStyle: "none"
    });
</script>
<!-- 给MathJax元素添加has-jax class -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>
<!-- 通过连接CDN加载MathJax的js代码 -->
<script type="text/javascript" async src="//cdn.jsdelivr.net/npm/mathjax@2.7.8/unpacked/MathJax.js?config=TeX-MML-AM_CHTML">
</script>
<input type="hidden" id="MathJax-js" value="//cdn.jsdelivr.net/npm/mathjax@2.7.8/unpacked/MathJax.js?config=TeX-MML-AM_CHTML">

    




    </div>
    <div class="copyright">
        <p class="footer-entry">
    ©2016-2020 Yelog
</p>
<p class="footer-entry">Built with <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/yelog/hexo-theme-3-hexo" target="_blank">3-hexo</a> theme</p>

    </div>
    <div class="full-toc">
        <button class="full" data-title="切换全屏 快捷键 s"><span class="min "></span></button>
<a class="" id="rocket"></a>

    </div>
</div>

<div class="hide_box" onclick="dashangToggle()"></div>
<div class="shang_box">
    <a class="shang_close" onclick="dashangToggle()">×</a>
    <div class="shang_tit">
        <p>Help us with donation</p>
    </div>
    <div class="shang_payimg">
        <div class="pay_img">
            <img src="/img/alipay.jpg" class="alipay" title="扫码支持">
            <img src="/img/weixin.jpg" class="weixin" title="扫码支持">
        </div>
    </div>
    <div class="shang_payselect">
        <span><label><input type="radio" name="pay" checked value="alipay">alipay</label></span><span><label><input type="radio" name="pay" value="weixin">weixin</label></span>
    </div>
</div><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config("");
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="custom_mathjax_source">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->


</body>
<script src="/js/jquery.pjax.js?v=1.1.0"></script>

<script src="/js/script.js?v=1.1.0"></script>
<script>
    var img_resize = 'default';
    function initArticle() {
        /*渲染对应的表格样式*/
        
            $("#post .pjax table").addClass("green_title");
        

        /*渲染打赏样式*/
        
        $("input[name=pay]").on("click", function () {
            if($("input[name=pay]:checked").val()=="weixin"){
                $(".shang_box .shang_payimg .pay_img").addClass("weixin_img");
            } else {
                $(".shang_box .shang_payimg .pay_img").removeClass("weixin_img");
            }
        })
        

        /*高亮代码块行号*/
        

        /*访问数量*/
        
        $.getScript("//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js");
        

        /*代码高亮，行号对齐*/
        $('.pre-numbering').css('line-height',$('.has-numbering').css('line-height'));

        
        
    }

    /*打赏页面隐藏与展示*/
    
    function dashangToggle() {
        $(".shang_box").fadeToggle();
        $(".hide_box").fadeToggle();
    }
    

</script>

<!--加入行号的高亮代码块样式-->

<!--自定义样式设置-->
<style>
    
    
    .nav {
        width: 542px;
    }
    .nav.fullscreen {
        margin-left: -542px;
    }
    .nav-left {
        width: 120px;
    }
    
    
    @media screen and (max-width: 1468px) {
        .nav {
            width: 492px;
        }
        .nav.fullscreen {
            margin-left: -492px;
        }
        .nav-left {
            width: 100px;
        }
    }
    
    
    @media screen and (max-width: 1024px) {
        .nav {
            width: 492px;
            margin-left: -492px
        }
        .nav.fullscreen {
            margin-left: 0;
        }
    }
    
    @media screen and (max-width: 426px) {
        .nav {
            width: 100%;
        }
        .nav-left {
            width: 100%;
        }
    }
    
    
    .nav-right .title-list nav a .post-title, .nav-right .title-list #local-search-result a .post-title {
        color: #383636;
    }
    
    
    .nav-right .title-list nav a .post-date, .nav-right .title-list #local-search-result a .post-date {
        color: #5e5e5f;
    }
    
    
    .nav-right nav a.hover, #local-search-result a.hover{
        background-color: #e2e0e0;
    }
    
    

    /*列表样式*/
    

    /* 背景图样式 */
    
    


    /*引用块样式*/
    

    /*文章列表背景图*/
    

    
</style>







</html>
